# 事件溯源 (Event Sourcing)

## 概述

事件溯源是一种数据持久化模式，它不存储实体的当前状态，而是存储导致该状态的所有事件序列。通过重放这些事件，可以重建任意时间点的实体状态。

## 优势

1. **回溯任意时间点的实体状态** - 可以查看系统在任何历史时刻的完整状态
2. **高性能写操作** - 持久化都是追加操作，不涉及修改现有数据
3. **良好的伸缩性** - 聚合的读写容易进行水平扩展，整个系统具备良好的可扩展性
4. **细粒度故障排查** - 通过观察领域模型状态的完整变化过程来定位问题
5. **灵活的模型设计** - 不需要考虑聚合持久化的复杂性，模型设计不受存储实现限制

## 限制

1. **必须设计可回溯的模型** - 需要保证可以从事件流中完整重建聚合状态
2. **必须采用 CQRS 模式** - 命令查询责任分离是事件溯源的必要架构模式
3. **重建能力需要编码实现** - 需要为每个聚合实现事件重放和状态重建逻辑

## 实现前提

**模型设计必须达到聚合完备性** - 聚合的所有状态变化都能通过事件来表达和重建

## 实现要点

### 核心实现
- **持久化领域事件** - 将所有状态变化以事件的形式存储
- **简化仓储保存** - 传统的实体保存功能可以简化，重点关注事件的持久化
- **优化查询方式** - 支持按ID查询，或构建索引先查出ID再获取聚合

### 快照机制
**使用场景：** 当聚合事件数量过多，导致重建性能下降时启用

**实现方式：**
- 定期保存聚合的完整状态到快照存储中
- 查询时先获取最近的快照，再基于后续事件重建聚合

### 快照创建时机
- **定时任务** - 按照固定时间间隔创建快照
- **事件保存时** - 在保存领域事件的同时判断是否需要创建快照
- **聚合读取时** - 在加载聚合时判断并创建快照

### 快照策略
- **事件数量阈值** - 快照后的领域事件数量达到设定阈值时创建新快照
- **特定事件触发** - 在发生特定类型的事件后创建快照
- **重建时间阈值** - 最近N次重建耗时超过设定阈值时创建快照
- **时间间隔策略** - 距离上次快照创建时间超过设定间隔时创建快照

## 适用场景

事件溯源适合在以下场景中采用：

1. **高性能写入需求** - 需要处理大量写操作的系统
2. **严格审计要求** - 需要完整记录和回溯任意时间点实体状态的系统
3. **时间旅行功能** - 需要支持历史状态查询和回滚的应用
4. **复杂故障排查** - 需要通过历史事件序列进行问题诊断
5. **灵活建模需求** - 希望领域模型设计不受存储层约束的项目

---

## 银行账户事件溯源示例 - AI 开发提示词

> 以下是用于指导 AI 开发银行账户事件溯源示例代码的详细需求说明

### 角色定义

你是一个领域驱动设计（DDD）和事件溯源（Event Sourcing）的专家。请根据以下要求编写一个简单的示例代码，展示如何使用事件溯源来管理一个银行账户的状态。

### 功能需求

#### 基础领域模型
1. 定义一个 `BankAccount` 聚合根，包含账户ID和余额
2. 定义一个 `DepositMoney` 命令，用于存款操作
3. 定义一个 `MoneyDeposited` 事件，表示存款已完成
4. 定义一个 `WithDrawMoney` 命令，用于取款操作
5. 定义一个 `MoneyWithdrawn` 事件，表示取款已完成

#### 存储层实现
6. 实现一个事件存储，用于保存和加载事件，使用 EFCore
7. 实现一个快照存储，用于保存和加载快照，使用 EFCore

#### 业务逻辑处理
8. 实现一个命令处理器，用于处理 `DepositMoney` 命令并生成相应的事件
9. 实现一个事件处理器，用于应用 `MoneyDeposited` 事件并更新账户余额
10. 定义一个 `GetAccountBalance` 查询，用于获取当前账户余额

#### 架构设计
11. 定义领域命令和领域事件的基类，让命令和事件继承这些基类
12. `BankAccount` 聚合根需要支持从事件流中重建其状态

#### 快照策略
13. `BankAccount` 聚合根需要定义一个接口用于判断是否需要创建新的快照
14. 这个接口可以根据事件数量或时间间隔来决定是否创建快照
15. 分别实现基于事件数量和时间间隔的快照策略

#### 时间旅行功能
16. 基于快照和事件可以指定任意时间点回溯账户状态

#### Web API 接口
17. 创建 WebApi 接口，支持以下操作：
    - 存款操作
    - 取款操作  
    - 查询余额
    - 回溯状态操作

### 技术栈要求

**开发平台：** .NET 10  
**编程语言：** C# 最新版本  
**ORM 框架：** Entity Framework Core
