# 事件溯源 (Event Sourcing) 示例项目

这是一个基于 .NET 和 Entity Framework Core 的事件溯源示例项目，展示了如何在银行账户系统中实现事件溯源模式。

## 目录

- [项目概述](#项目概述)
- [事件溯源简介](#事件溯源简介)
- [项目结构](#项目结构)
- [技术栈](#技术栈)
- [快速开始](#快速开始)
- [AI 提示词参考](#ai-提示词参考)

## 项目概述

本项目实现了一个完整的事件溯源系统，包含：

- **银行账户聚合根**：支持创建账户、存款、取款等操作
- **事件存储**：持久化所有领域事件
- **快照功能**：优化聚合重建性能
- **时间穿越**：可回溯到任意时间点的账户状态
- **CQRS 模式**：命令查询职责分离
- **RESTful API**：提供完整的 Web API 接口

## 事件溯源简介

### 优势

1. **回溯能力**：可回溯任意时间点的实体状态
2. **高性能写入**：持久化都是追加操作，不修改已有数据
3. **伸缩性**：聚合读写容易伸缩，进而整个业务系统都容易伸缩
4. **细粒度排障**：观察领域模型状态的变化过程来排障
5. **建模自由**：不需要考虑聚合持久化，模型设计不需要考虑存储实现

### 限制

1. **模型复杂性**：必须设计可回溯的模型，保证可以重建聚合
2. **强制 CQRS**：必须实现命令查询职责分离
3. **重建实现**：重建能力需要编码实现

### 适用场景

事件溯源在以下场景下特别有用：

1. **高性能写入需求**
2. **严格审计要求**（需要回溯任意时间点的实体状态）
3. **时间穿越功能**
4. **复杂排障需求**
5. **灵活建模需求**

## 项目结构

```
EventSourcingBankAccount/
├── EventSourcingBankAccount.Api/          # Web API 层
├── EventSourcingBankAccount.Domain/       # 领域层
└── EventSourcingBankAccount.Infrastructure/ # 基础设施层
```

### 核心实现

#### 事件存储实现
- 持久化领域事件
- 仓储的保存功能基于事件流
- 查询方法：按 ID 查询，或者提前构建索引

#### 快照机制
- **用途**：当聚合事件较多时，优化重建性能
- **策略**：每发生一定数量事件后，保存聚合完整状态
- **查询优化**：先查询最近快照，再根据后续事件重建聚合

#### 快照策略
支持多种快照创建策略：

1. **基于事件数量**：快照后领域事件数量达到某个阈值
2. **基于时间间隔**：距离上次快照时间间隔达到阈值
3. **基于事件类型**：特定事件发生后创建快照
4. **基于重建时间**：最近 N 次重建时间超过阈值

#### 快照创建时机
- 定时任务
- 保存领域事件时
- 读取聚合时

## 技术栈

- **.NET 8.0**：主要开发框架
- **C# 最新版本**：编程语言
- **Entity Framework Core**：ORM 框架
- **SQLite**：默认数据库（支持配置其他数据库）
- **ASP.NET Core Web API**：API 框架

## 快速开始

### 环境要求

- .NET 8.0 SDK
- SQLite（或其他支持的数据库）

### 运行项目

1. 克隆项目到本地
2. 在项目根目录执行：
   ```bash
   dotnet restore
   dotnet build
   dotnet run --project EventSourcingBankAccount.Api
   ```

### API 接口

项目提供以下主要 API 接口：

- `POST /api/bankaccount` - 创建账户
- `POST /api/bankaccount/{accountId}/deposit` - 存款
- `POST /api/bankaccount/{accountId}/withdraw` - 取款
- `GET /api/bankaccount/{accountId}/balance` - 查询余额
- `GET /api/bankaccount/{accountId}/state?pointInTime={datetime}` - 回溯状态

## AI 提示词参考

> 这是用于生成此项目的 AI 提示词，供学习和参考使用。

### 项目需求

你是一个领域驱动设计（DDD）和事件溯源（Event Sourcing）的专家。请根据以下要求编写一个简单的示例代码，展示如何使用事件溯源来管理一个银行账户的状态。

### 功能要求

1. **聚合根设计**
   - 定义一个 `BankAccount` 聚合根，包含账户ID和余额
   - 支持从事件流中重建聚合状态

2. **命令定义**
   - `CreateAccount` 命令：创建账户
   - `DepositMoney` 命令：存款操作
   - `WithdrawMoney` 命令：取款操作

3. **事件定义**
   - `AccountCreated` 事件：账户已创建
   - `MoneyDeposited` 事件：存款已完成
   - `MoneyWithdrawn` 事件：取款已完成

4. **基础设施层**
   - 实现事件存储，使用 Entity Framework Core
   - 实现快照存储，使用 Entity Framework Core
   - 命令处理器：处理命令并生成相应事件
   - 查询处理器：处理查询请求

5. **查询功能**
   - `GetAccountBalance` 查询：获取当前账户余额
   - `GetAccountStateAtTime` 查询：回溯任意时间点的账户状态

6. **快照策略**
   - 定义快照接口，判断是否需要创建新快照
   - 实现基于事件数量的快照策略
   - 实现基于时间间隔的快照策略
   - 实现组合快照策略

7. **Web API 接口**
   - 支持存款、取款操作
   - 支持查询余额功能
   - 支持回溯状态功能

8. **领域基类**
   - 定义领域命令基类
   - 定义领域事件基类
   - 实现聚合根基类

### 技术要求

- 使用 .NET 8.0 及 C# 最新版本
- 使用 Entity Framework Core 作为 ORM 框架
- 实现完整的 CQRS 模式
- 支持依赖注入和服务配置